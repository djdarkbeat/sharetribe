<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  Class: PeopleController
  
    &mdash; Documentation by YARD 0.9.19
  
</title>

  <link rel="stylesheet" href="css/style.css" type="text/css" charset="utf-8" />

  <link rel="stylesheet" href="css/common.css" type="text/css" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  pathId = "PeopleController";
  relpath = '';
</script>


  <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="class_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="_index.html">Index (P)</a> &raquo;
    
    
    <span class="title">PeopleController</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><h1>Class: PeopleController
  
  
  
</h1>
<div class="box_info">
  
  <dl>
    <dt>Inherits:</dt>
    <dd>
      <span class="inheritName">Devise::RegistrationsController</span>
      
        <ul class="fullTree">
          <li>Object</li>
          
            <li class="next">Devise::RegistrationsController</li>
          
            <li class="next">PeopleController</li>
          
        </ul>
        <a href="#" class="inheritanceTree">show all</a>
      
    </dd>
  </dl>
  

  
  
  
  
  

  

  
  <dl>
    <dt>Defined in:</dt>
    <dd>app/controllers/people_controller.rb</dd>
  </dl>
  
</div>


  
    <h2>
      Constant Summary
      <small><a href="#" class="constants_summary_toggle">collapse</a></small>
    </h2>

    <dl class="constants">
      
        <dt id="LOOSER_ACCESS_CONTROL-constant" class="">LOOSER_ACCESS_CONTROL =
          
        </dt>
        <dd><pre class="code"><span class='lbracket'>[</span>
  <span class='symbol'>:check_email_availability</span><span class='comma'>,</span>
  <span class='symbol'>:check_email_availability_and_validity</span><span class='comma'>,</span>
  <span class='symbol'>:check_invitation_code</span>
<span class='rbracket'>]</span></pre></dd>
      
    </dl>
  







  
    <h2>
      Instance Method Summary
      <small><a href="#" class="summary_toggle">collapse</a></small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#build_devise_resource_from_person-instance_method" title="#build_devise_resource_from_person (instance method)">#<strong>build_devise_resource_from_person</strong>(person_params)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#check_email_availability-instance_method" title="#check_email_availability (instance method)">#<strong>check_email_availability</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>this checks that email is not already in use for anyone (including current user).</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#check_email_availability_and_validity-instance_method" title="#check_email_availability_and_validity (instance method)">#<strong>check_email_availability_and_validity</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#check_invitation_code-instance_method" title="#check_invitation_code (instance method)">#<strong>check_invitation_code</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#create-instance_method" title="#create (instance method)">#<strong>create</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#destroy-instance_method" title="#destroy (instance method)">#<strong>destroy</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#new-instance_method" title="#new (instance method)">#<strong>new</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#show-instance_method" title="#show (instance method)">#<strong>show</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#show_closed%3F-instance_method" title="#show_closed? (instance method)">#<strong>show_closed?</strong>  &#x21d2; Boolean </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#update-instance_method" title="#update (instance method)">#<strong>update</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
    </ul>
  


  

  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="build_devise_resource_from_person-instance_method">
  
    #<strong>build_devise_resource_from_person</strong>(person_params)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


115
116
117
118
119
120
121
122
123</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/controllers/people_controller.rb', line 115</span>

<span class='kw'>def</span> <span class='id identifier rubyid_build_devise_resource_from_person'>build_devise_resource_from_person</span><span class='lparen'>(</span><span class='id identifier rubyid_person_params'>person_params</span><span class='rparen'>)</span>
  <span class='comment'>#remove terms part which confuses Devise
</span>  <span class='id identifier rubyid_person_params'>person_params</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span><span class='symbol'>:terms</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_person_params'>person_params</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span><span class='symbol'>:admin_emails_consent</span><span class='rparen'>)</span>

  <span class='comment'># This part is copied from Devise&#39;s regstration_controller#create
</span>  <span class='id identifier rubyid_build_resource'>build_resource</span><span class='lparen'>(</span><span class='id identifier rubyid_person_params'>person_params</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_resource'>resource</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="check_email_availability-instance_method">
  
    #<strong>check_email_availability</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>this checks that email is not already in use for anyone (including current user)</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


226
227
228
229
230
231
232</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/controllers/people_controller.rb', line 226</span>

<span class='kw'>def</span> <span class='id identifier rubyid_check_email_availability'>check_email_availability</span>
  <span class='id identifier rubyid_email'>email</span> <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:person</span><span class='rbracket'>]</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:person</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:email_attributes</span><span class='rbracket'>]</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:person</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:email_attributes</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:address</span><span class='rbracket'>]</span>

  <span class='id identifier rubyid_respond_to'>respond_to</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_format'>format</span><span class='op'>|</span>
    <span class='id identifier rubyid_format'>format</span><span class='period'>.</span><span class='id identifier rubyid_json'>json</span> <span class='lbrace'>{</span> <span class='id identifier rubyid_render'>render</span> <span class='label'>json:</span> <span class='const'><span class='object_link'><a href="Email.html" title="Email (class)">Email</a></span></span><span class='period'>.</span><span class='id identifier rubyid_email_available?'><span class='object_link'><a href="Email.html#email_available%3F-class_method" title="Email.email_available? (method)">email_available?</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_email'>email</span><span class='comma'>,</span> <span class='ivar'>@current_community</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rparen'>)</span> <span class='rbrace'>}</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="check_email_availability_and_validity-instance_method">
  
    #<strong>check_email_availability_and_validity</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


215
216
217
218
219
220
221
222
223</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/controllers/people_controller.rb', line 215</span>

<span class='kw'>def</span> <span class='id identifier rubyid_check_email_availability_and_validity'>check_email_availability_and_validity</span>
  <span class='id identifier rubyid_email'>email</span> <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:person</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:email</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='period'>.</span><span class='id identifier rubyid_downcase'>downcase</span>

  <span class='id identifier rubyid_allowed_and_available'>allowed_and_available</span> <span class='op'>=</span> <span class='ivar'>@current_community</span><span class='period'>.</span><span class='id identifier rubyid_email_allowed?'>email_allowed?</span><span class='lparen'>(</span><span class='id identifier rubyid_email'>email</span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span> <span class='const'><span class='object_link'><a href="Email.html" title="Email (class)">Email</a></span></span><span class='period'>.</span><span class='id identifier rubyid_email_available?'><span class='object_link'><a href="Email.html#email_available%3F-class_method" title="Email.email_available? (method)">email_available?</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_email'>email</span><span class='comma'>,</span> <span class='ivar'>@current_community</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rparen'>)</span>

  <span class='id identifier rubyid_respond_to'>respond_to</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_format'>format</span><span class='op'>|</span>
    <span class='id identifier rubyid_format'>format</span><span class='period'>.</span><span class='id identifier rubyid_json'>json</span> <span class='lbrace'>{</span> <span class='id identifier rubyid_render'>render</span> <span class='label'>json:</span> <span class='id identifier rubyid_allowed_and_available'>allowed_and_available</span> <span class='rbrace'>}</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="check_invitation_code-instance_method">
  
    #<strong>check_invitation_code</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


234
235
236
237
238</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/controllers/people_controller.rb', line 234</span>

<span class='kw'>def</span> <span class='id identifier rubyid_check_invitation_code'>check_invitation_code</span>
  <span class='id identifier rubyid_respond_to'>respond_to</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_format'>format</span><span class='op'>|</span>
    <span class='id identifier rubyid_format'>format</span><span class='period'>.</span><span class='id identifier rubyid_json'>json</span> <span class='lbrace'>{</span> <span class='id identifier rubyid_render'>render</span> <span class='symbol'>:json</span> <span class='op'>=&gt;</span> <span class='const'><span class='object_link'><a href="Invitation.html" title="Invitation (class)">Invitation</a></span></span><span class='period'>.</span><span class='id identifier rubyid_code_usable?'><span class='object_link'><a href="Invitation.html#code_usable%3F-class_method" title="Invitation.code_usable? (method)">code_usable?</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:invitation_code</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='ivar'>@current_community</span><span class='rparen'>)</span> <span class='rbrace'>}</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="create-instance_method">
  
    #<strong>create</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/controllers/people_controller.rb', line 43</span>

<span class='kw'>def</span> <span class='id identifier rubyid_create'>create</span>
  <span class='id identifier rubyid_domain'>domain</span> <span class='op'>=</span> <span class='ivar'>@current_community</span> <span class='op'>?</span> <span class='ivar'>@current_community</span><span class='period'>.</span><span class='id identifier rubyid_full_url'>full_url</span> <span class='op'>:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_request'>request</span><span class='period'>.</span><span class='id identifier rubyid_protocol'>protocol</span><span class='embexpr_end'>}</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_request'>request</span><span class='period'>.</span><span class='id identifier rubyid_host_with_port'>host_with_port</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_error_redirect_path'>error_redirect_path</span> <span class='op'>=</span> <span class='id identifier rubyid_domain'>domain</span> <span class='op'>+</span> <span class='id identifier rubyid_sign_up_path'>sign_up_path</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:person</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span> <span class='op'>||</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:person</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:input_again</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_present?'>present?</span> <span class='comment'># Honey pot for spammerbots
</span>    <span class='id identifier rubyid_flash'>flash</span><span class='lbracket'>[</span><span class='symbol'>:error</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_t'>t</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>layouts.notifications.registration_considered_spam</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Honey pot: Registration Honey Pot is hit.</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_redirect_to'>redirect_to</span> <span class='id identifier rubyid_error_redirect_path'>error_redirect_path</span> <span class='kw'>and</span> <span class='kw'>return</span>
  <span class='kw'>end</span>

  <span class='kw'>if</span> <span class='ivar'>@current_community</span> <span class='op'>&amp;&amp;</span> <span class='ivar'>@current_community</span><span class='period'>.</span><span class='id identifier rubyid_join_with_invite_only?'>join_with_invite_only?</span> <span class='op'>||</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:invitation_code</span><span class='rbracket'>]</span>

    <span class='kw'>unless</span> <span class='const'><span class='object_link'><a href="Invitation.html" title="Invitation (class)">Invitation</a></span></span><span class='period'>.</span><span class='id identifier rubyid_code_usable?'><span class='object_link'><a href="Invitation.html#code_usable%3F-class_method" title="Invitation.code_usable? (method)">code_usable?</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:invitation_code</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='ivar'>@current_community</span><span class='rparen'>)</span>
      <span class='comment'># abort user creation if invitation is not usable.
</span>      <span class='comment'># (This actually should not happen since the code is checked with javascript)
</span>      <span class='id identifier rubyid_session'>session</span><span class='lbracket'>[</span><span class='symbol'>:invitation_code</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='kw'>nil</span> <span class='comment'># reset code from session if there was issues so that&#39;s not used again
</span>      <span class='const'><span class='object_link'><a href="ApplicationHelper.html" title="ApplicationHelper (module)">ApplicationHelper</a></span></span><span class='period'>.</span><span class='id identifier rubyid_send_error_notification'><span class='object_link'><a href="ApplicationHelper.html#send_error_notification-class_method" title="ApplicationHelper.send_error_notification (method)">send_error_notification</a></span></span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Invitation code check did not prevent submiting form, but was detected in the controller</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Invitation code error</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>

      <span class='comment'># TODO: if this ever happens, should change the message to something else than &quot;unknown error&quot;
</span>      <span class='id identifier rubyid_flash'>flash</span><span class='lbracket'>[</span><span class='symbol'>:error</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_t'>t</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>layouts.notifications.unknown_error</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
      <span class='id identifier rubyid_redirect_to'>redirect_to</span> <span class='id identifier rubyid_error_redirect_path'>error_redirect_path</span> <span class='kw'>and</span> <span class='kw'>return</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_invitation'>invitation</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Invitation.html" title="Invitation (class)">Invitation</a></span></span><span class='period'>.</span><span class='id identifier rubyid_find_by_code'>find_by_code</span><span class='lparen'>(</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:invitation_code</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_upcase'>upcase</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='kw'>return</span> <span class='kw'>if</span> <span class='id identifier rubyid_email_not_valid'>email_not_valid</span><span class='lparen'>(</span><span class='id identifier rubyid_params'>params</span><span class='comma'>,</span> <span class='id identifier rubyid_error_redirect_path'>error_redirect_path</span><span class='rparen'>)</span>

  <span class='id identifier rubyid_email'>email</span> <span class='op'>=</span> <span class='kw'>nil</span>
  <span class='kw'>begin</span>
    <span class='const'>ActiveRecord</span><span class='op'>::</span><span class='const'>Base</span><span class='period'>.</span><span class='id identifier rubyid_transaction'>transaction</span> <span class='kw'>do</span>
      <span class='ivar'>@person</span><span class='comma'>,</span> <span class='id identifier rubyid_email'>email</span> <span class='op'>=</span> <span class='id identifier rubyid_new_person'>new_person</span><span class='lparen'>(</span><span class='id identifier rubyid_params'>params</span><span class='comma'>,</span> <span class='ivar'>@current_community</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>rescue</span> <span class='const'>StandardError</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
    <span class='id identifier rubyid_flash'>flash</span><span class='lbracket'>[</span><span class='symbol'>:error</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_t'>t</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>people.new.invalid_username_or_email</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='id identifier rubyid_redirect_to'>redirect_to</span> <span class='id identifier rubyid_error_redirect_path'>error_redirect_path</span> <span class='kw'>and</span> <span class='kw'>return</span>
  <span class='kw'>end</span>

  <span class='comment'># Make person a member of the current community
</span>  <span class='kw'>if</span> <span class='ivar'>@current_community</span>
    <span class='id identifier rubyid_membership'>membership</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="CommunityMembership.html" title="CommunityMembership (class)">CommunityMembership</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>person:</span> <span class='ivar'>@person</span><span class='comma'>,</span> <span class='label'>community:</span> <span class='ivar'>@current_community</span><span class='comma'>,</span> <span class='label'>consent:</span> <span class='ivar'>@current_community</span><span class='period'>.</span><span class='id identifier rubyid_consent'>consent</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_membership'>membership</span><span class='period'>.</span><span class='id identifier rubyid_status'>status</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>pending_email_confirmation</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_membership'>membership</span><span class='period'>.</span><span class='id identifier rubyid_invitation'>invitation</span> <span class='op'>=</span> <span class='id identifier rubyid_invitation'>invitation</span> <span class='kw'>if</span> <span class='id identifier rubyid_invitation'>invitation</span><span class='period'>.</span><span class='id identifier rubyid_present?'>present?</span>
    <span class='comment'># If the community doesn&#39;t have any members, make the first one an admin
</span>    <span class='kw'>if</span> <span class='ivar'>@current_community</span><span class='period'>.</span><span class='id identifier rubyid_members'>members</span><span class='period'>.</span><span class='id identifier rubyid_count'>count</span> <span class='op'>==</span> <span class='int'>0</span>
      <span class='id identifier rubyid_membership'>membership</span><span class='period'>.</span><span class='id identifier rubyid_admin'>admin</span> <span class='op'>=</span> <span class='kw'>true</span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_membership'>membership</span><span class='period'>.</span><span class='id identifier rubyid_save!'>save!</span>
    <span class='id identifier rubyid_session'>session</span><span class='lbracket'>[</span><span class='symbol'>:invitation_code</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='kw'>nil</span>
  <span class='kw'>end</span>

  <span class='comment'># If invite was used, reduce usages left
</span>  <span class='id identifier rubyid_invitation'>invitation</span><span class='period'>.</span><span class='id identifier rubyid_use_once!'>use_once!</span> <span class='kw'>if</span> <span class='id identifier rubyid_invitation'>invitation</span><span class='period'>.</span><span class='id identifier rubyid_present?'>present?</span>

  <span class='const'>Delayed</span><span class='op'>::</span><span class='const'>Job</span><span class='period'>.</span><span class='id identifier rubyid_enqueue'>enqueue</span><span class='lparen'>(</span><span class='const'><span class='object_link'><a href="CommunityJoinedJob.html" title="CommunityJoinedJob (class)">CommunityJoinedJob</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='ivar'>@person</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='comma'>,</span> <span class='ivar'>@current_community</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rparen'>)</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='ivar'>@current_community</span>

  <span class='id identifier rubyid_record_event'>record_event</span><span class='lparen'>(</span><span class='id identifier rubyid_flash'>flash</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>SignUp</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>method:</span> <span class='symbol'>:email</span><span class='rparen'>)</span>

  <span class='comment'># send email confirmation
</span>  <span class='comment'># (unless disabled for testing environment)
</span>  <span class='kw'>if</span> <span class='const'>APP_CONFIG</span><span class='period'>.</span><span class='id identifier rubyid_skip_email_confirmation'>skip_email_confirmation</span>
    <span class='id identifier rubyid_email'>email</span><span class='period'>.</span><span class='id identifier rubyid_confirm!'>confirm!</span>

    <span class='id identifier rubyid_redirect_to'>redirect_to</span> <span class='id identifier rubyid_search_path'><span class='object_link'><a href="ApplicationHelper.html#search_path-instance_method" title="ApplicationHelper#search_path (method)">search_path</a></span></span>
  <span class='kw'>else</span>
    <span class='const'><span class='object_link'><a href="Email.html" title="Email (class)">Email</a></span></span><span class='period'>.</span><span class='id identifier rubyid_send_confirmation'><span class='object_link'><a href="Email.html#send_confirmation-class_method" title="Email.send_confirmation (method)">send_confirmation</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_email'>email</span><span class='comma'>,</span> <span class='ivar'>@current_community</span><span class='rparen'>)</span>

    <span class='id identifier rubyid_flash'>flash</span><span class='lbracket'>[</span><span class='symbol'>:notice</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_t'>t</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>layouts.notifications.account_creation_succesful_you_still_need_to_confirm_your_email</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='id identifier rubyid_redirect_to'>redirect_to</span> <span class='id identifier rubyid_confirmation_pending_path'>confirmation_pending_path</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="destroy-instance_method">
  
    #<strong>destroy</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/controllers/people_controller.rb', line 187</span>

<span class='kw'>def</span> <span class='id identifier rubyid_destroy'>destroy</span>
  <span class='id identifier rubyid_target_user'>target_user</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Person.html" title="Person (class)">Person</a></span></span><span class='period'>.</span><span class='id identifier rubyid_find_by!'>find_by!</span><span class='lparen'>(</span><span class='label'>username:</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:id</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='label'>community_id:</span> <span class='ivar'>@current_community</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rparen'>)</span>

  <span class='id identifier rubyid_has_unfinished'>has_unfinished</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="TransactionService.html" title="TransactionService (module)">TransactionService</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="TransactionService/Transaction.html" title="TransactionService::Transaction (module)">Transaction</a></span></span><span class='period'>.</span><span class='id identifier rubyid_has_unfinished_transactions'><span class='object_link'><a href="TransactionService/Transaction.html#has_unfinished_transactions-class_method" title="TransactionService::Transaction.has_unfinished_transactions (method)">has_unfinished_transactions</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_target_user'>target_user</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_only_admin'>only_admin</span> <span class='op'>=</span> <span class='ivar'>@current_community</span><span class='period'>.</span><span class='id identifier rubyid_is_person_only_admin'>is_person_only_admin</span><span class='lparen'>(</span><span class='id identifier rubyid_target_user'>target_user</span><span class='rparen'>)</span>

  <span class='kw'>return</span> <span class='id identifier rubyid_redirect_to'>redirect_to</span> <span class='id identifier rubyid_search_path'><span class='object_link'><a href="ApplicationHelper.html#search_path-instance_method" title="ApplicationHelper#search_path (method)">search_path</a></span></span> <span class='kw'>if</span> <span class='id identifier rubyid_has_unfinished'>has_unfinished</span> <span class='op'>||</span> <span class='id identifier rubyid_only_admin'>only_admin</span>

  <span class='id identifier rubyid_stripe_del'>stripe_del</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="StripeService.html" title="StripeService (module)">StripeService</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="StripeService/API.html" title="StripeService::API (module)">API</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="StripeService/API/Api.html" title="StripeService::API::Api (class)">Api</a></span></span><span class='period'>.</span><span class='id identifier rubyid_accounts'><span class='object_link'><a href="StripeService/API/Api.html#accounts-class_method" title="StripeService::API::Api.accounts (method)">accounts</a></span></span><span class='period'>.</span><span class='id identifier rubyid_delete_seller_account'>delete_seller_account</span><span class='lparen'>(</span><span class='label'>community_id:</span> <span class='ivar'>@current_community</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='comma'>,</span>
                                                                      <span class='label'>person_id:</span> <span class='id identifier rubyid_target_user'>target_user</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rparen'>)</span>
  <span class='kw'>unless</span> <span class='id identifier rubyid_stripe_del'>stripe_del</span><span class='lbracket'>[</span><span class='symbol'>:success</span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_flash'>flash</span><span class='lbracket'>[</span><span class='symbol'>:error</span><span class='rbracket'>]</span> <span class='op'>=</span>  <span class='id identifier rubyid_t'>t</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>layouts.notifications.stripe_you_account_balance_is_not_0</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='kw'>return</span> <span class='id identifier rubyid_redirect_to'>redirect_to</span> <span class='id identifier rubyid_search_path'><span class='object_link'><a href="ApplicationHelper.html#search_path-instance_method" title="ApplicationHelper#search_path (method)">search_path</a></span></span>
  <span class='kw'>end</span>

  <span class='comment'># Do all delete operations in transaction. Rollback if any of them fails
</span>  <span class='const'>ActiveRecord</span><span class='op'>::</span><span class='const'>Base</span><span class='period'>.</span><span class='id identifier rubyid_transaction'>transaction</span> <span class='kw'>do</span>
    <span class='const'><span class='object_link'><a href="Person.html" title="Person (class)">Person</a></span></span><span class='period'>.</span><span class='id identifier rubyid_delete_user'>delete_user</span><span class='lparen'>(</span><span class='id identifier rubyid_target_user'>target_user</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rparen'>)</span>
    <span class='const'><span class='object_link'><a href="Listing.html" title="Listing (class)">Listing</a></span></span><span class='period'>.</span><span class='id identifier rubyid_delete_by_author'><span class='object_link'><a href="Listing.html#delete_by_author-class_method" title="Listing.delete_by_author (method)">delete_by_author</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_target_user'>target_user</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rparen'>)</span>
    <span class='const'><span class='object_link'><a href="PaypalAccount.html" title="PaypalAccount (class)">PaypalAccount</a></span></span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='label'>person_id:</span> <span class='id identifier rubyid_target_user'>target_user</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='comma'>,</span> <span class='label'>community_id:</span> <span class='id identifier rubyid_target_user'>target_user</span><span class='period'>.</span><span class='id identifier rubyid_community_id'>community_id</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_delete_all'>delete_all</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_sign_out'>sign_out</span> <span class='id identifier rubyid_target_user'>target_user</span>
  <span class='id identifier rubyid_record_event'>record_event</span><span class='lparen'>(</span><span class='id identifier rubyid_flash'>flash</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>user</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='lbrace'>{</span><span class='label'>action:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>deleted</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>opt_label:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>by user</span><span class='tstring_end'>&quot;</span></span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_flash'>flash</span><span class='lbracket'>[</span><span class='symbol'>:notice</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_t'>t</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>layouts.notifications.account_deleted</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='id identifier rubyid_redirect_to'>redirect_to</span> <span class='id identifier rubyid_search_path'><span class='object_link'><a href="ApplicationHelper.html#search_path-instance_method" title="ApplicationHelper#search_path (method)">search_path</a></span></span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="new-instance_method">
  
    #<strong>new</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


31
32
33
34
35
36
37
38
39
40
41</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/controllers/people_controller.rb', line 31</span>

<span class='kw'>def</span> <span class='id identifier rubyid_new'>new</span>
  <span class='ivar'>@selected_tribe_navi_tab</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>members</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_redirect_to'>redirect_to</span> <span class='id identifier rubyid_search_path'><span class='object_link'><a href="ApplicationHelper.html#search_path-instance_method" title="ApplicationHelper#search_path (method)">search_path</a></span></span> <span class='kw'>if</span> <span class='id identifier rubyid_logged_in?'>logged_in?</span>
  <span class='id identifier rubyid_session'>session</span><span class='lbracket'>[</span><span class='symbol'>:invitation_code</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:code</span><span class='rbracket'>]</span> <span class='kw'>if</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:code</span><span class='rbracket'>]</span>
  <span class='ivar'>@service</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Person.html" title="Person (class)">Person</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Person/SettingsService.html" title="Person::SettingsService (class)">SettingsService</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="Person/SettingsService.html#initialize-instance_method" title="Person::SettingsService#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='label'>community:</span> <span class='ivar'>@current_community</span><span class='comma'>,</span> <span class='label'>params:</span> <span class='id identifier rubyid_params'>params</span><span class='comma'>,</span>
                                         <span class='label'>required_fields_only:</span> <span class='kw'>true</span><span class='rparen'>)</span>
  <span class='ivar'>@service</span><span class='period'>.</span><span class='id identifier rubyid_new_person'>new_person</span>

  <span class='ivar'>@container_class</span> <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:private_community</span><span class='rbracket'>]</span> <span class='op'>?</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>container_12</span><span class='tstring_end'>&quot;</span></span> <span class='op'>:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>container_24</span><span class='tstring_end'>&quot;</span></span>
  <span class='ivar'>@grid_class</span> <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:private_community</span><span class='rbracket'>]</span> <span class='op'>?</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>grid_6 prefix_3 suffix_3</span><span class='tstring_end'>&quot;</span></span> <span class='op'>:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>grid_10 prefix_7 suffix_7</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="show-instance_method">
  
    #<strong>show</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


23
24
25
26
27
28
29</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/controllers/people_controller.rb', line 23</span>

<span class='kw'>def</span> <span class='id identifier rubyid_show'>show</span>
  <span class='ivar'>@service</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Person.html" title="Person (class)">Person</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Person/ShowService.html" title="Person::ShowService (class)">ShowService</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="Person/ShowService.html#initialize-instance_method" title="Person::ShowService#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='label'>community:</span> <span class='ivar'>@current_community</span><span class='comma'>,</span> <span class='label'>params:</span> <span class='id identifier rubyid_params'>params</span><span class='comma'>,</span> <span class='label'>current_user:</span> <span class='ivar'>@current_user</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_redirect_to'>redirect_to</span> <span class='id identifier rubyid_landing_page_path'><span class='object_link'><a href="ApplicationHelper.html#landing_page_path-instance_method" title="ApplicationHelper#landing_page_path (method)">landing_page_path</a></span></span> <span class='kw'>and</span> <span class='kw'>return</span> <span class='kw'>unless</span> <span class='ivar'>@service</span><span class='period'>.</span><span class='id identifier rubyid_person'>person</span>
  <span class='id identifier rubyid_redirect_to'>redirect_to</span> <span class='id identifier rubyid_landing_page_path'><span class='object_link'><a href="ApplicationHelper.html#landing_page_path-instance_method" title="ApplicationHelper#landing_page_path (method)">landing_page_path</a></span></span> <span class='kw'>and</span> <span class='kw'>return</span> <span class='kw'>if</span> <span class='ivar'>@current_community</span><span class='period'>.</span><span class='id identifier rubyid_private?'>private?</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='ivar'>@current_user</span>
  <span class='ivar'>@selected_tribe_navi_tab</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>members</span><span class='tstring_end'>&quot;</span></span>
  <span class='ivar'>@seo_service</span><span class='period'>.</span><span class='id identifier rubyid_user'>user</span> <span class='op'>=</span> <span class='ivar'>@service</span><span class='period'>.</span><span class='id identifier rubyid_person'>person</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="show_closed?-instance_method">
  
    #<strong>show_closed?</strong>  &#x21d2; <tt>Boolean</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    

  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


240
241
242</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/controllers/people_controller.rb', line 240</span>

<span class='kw'>def</span> <span class='id identifier rubyid_show_closed?'>show_closed?</span>
  <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:closed</span><span class='rbracket'>]</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:closed</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_eql?'>eql?</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>true</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="update-instance_method">
  
    #<strong>update</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/controllers/people_controller.rb', line 125</span>

<span class='kw'>def</span> <span class='id identifier rubyid_update'>update</span>
  <span class='id identifier rubyid_target_user'>target_user</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Person.html" title="Person (class)">Person</a></span></span><span class='period'>.</span><span class='id identifier rubyid_find_by!'>find_by!</span><span class='lparen'>(</span><span class='label'>username:</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:id</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='label'>community_id:</span> <span class='ivar'>@current_community</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='ivar'>@current_user</span> <span class='op'>!=</span> <span class='id identifier rubyid_target_user'>target_user</span>
    <span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_info'>info</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>ADMIN ACTION: admin=&#39;</span><span class='embexpr_beg'>#{</span><span class='ivar'>@current_user</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39; update person=&#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_target_user'>target_user</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39; params=</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_params'>params</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
  <span class='comment'># If setting new location, delete old one first
</span>  <span class='kw'>if</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:person</span><span class='rbracket'>]</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:person</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:location</span><span class='rbracket'>]</span> <span class='op'>&amp;&amp;</span> <span class='lparen'>(</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:person</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:location</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:address</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span> <span class='op'>||</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:person</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:street_address</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_blank?'>blank?</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:person</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>location</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_target_user'>target_user</span><span class='period'>.</span><span class='id identifier rubyid_location'>location</span>
      <span class='id identifier rubyid_target_user'>target_user</span><span class='period'>.</span><span class='id identifier rubyid_location'>location</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='comment'>#Check that people don&#39;t exploit changing email to be confirmed to join an email restricted community
</span>  <span class='kw'>if</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>request_new_email_confirmation</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span> <span class='op'>&amp;&amp;</span> <span class='ivar'>@current_community</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span> <span class='ivar'>@current_community</span><span class='period'>.</span><span class='id identifier rubyid_email_allowed?'>email_allowed?</span><span class='lparen'>(</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:person</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:email</span><span class='rbracket'>]</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_flash'>flash</span><span class='lbracket'>[</span><span class='symbol'>:error</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_t'>t</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>people.new.email_not_allowed</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='id identifier rubyid_redirect_back'>redirect_back</span><span class='lparen'>(</span><span class='label'>fallback_location:</span> <span class='id identifier rubyid_homepage_url'>homepage_url</span><span class='rparen'>)</span> <span class='kw'>and</span> <span class='kw'>return</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_target_user'>target_user</span><span class='period'>.</span><span class='id identifier rubyid_set_emails_that_receive_notifications'>set_emails_that_receive_notifications</span><span class='lparen'>(</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:person</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:send_notifications</span><span class='rbracket'>]</span><span class='rparen'>)</span>

  <span class='kw'>begin</span>
    <span class='id identifier rubyid_person_params'>person_params</span> <span class='op'>=</span> <span class='id identifier rubyid_person_update_params'>person_update_params</span><span class='lparen'>(</span><span class='id identifier rubyid_params'>params</span><span class='comma'>,</span> <span class='id identifier rubyid_target_user'>target_user</span><span class='rparen'>)</span>

    <span class='const'>Maybe</span><span class='lparen'>(</span><span class='id identifier rubyid_person_params'>person_params</span><span class='rparen'>)</span><span class='lbracket'>[</span><span class='symbol'>:location</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_loc'>loc</span><span class='op'>|</span>
      <span class='id identifier rubyid_person_params'>person_params</span><span class='lbracket'>[</span><span class='symbol'>:location</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_loc'>loc</span><span class='period'>.</span><span class='id identifier rubyid_merge'>merge</span><span class='lparen'>(</span><span class='label'>location_type:</span> <span class='symbol'>:person</span><span class='rparen'>)</span>
    <span class='rbrace'>}</span>

    <span class='id identifier rubyid_m_email_address'>m_email_address</span> <span class='op'>=</span> <span class='const'>Maybe</span><span class='lparen'>(</span><span class='id identifier rubyid_person_params'>person_params</span><span class='rparen'>)</span><span class='lbracket'>[</span><span class='symbol'>:email_attributes</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:address</span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_m_email_address'>m_email_address</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_new_email_address'>new_email_address</span><span class='op'>|</span>
      <span class='comment'># This only builds the emails, they will be saved when `update_attributes` is called
</span>      <span class='id identifier rubyid_target_user'>target_user</span><span class='period'>.</span><span class='id identifier rubyid_emails'>emails</span><span class='period'>.</span><span class='id identifier rubyid_build'>build</span><span class='lparen'>(</span><span class='label'>address:</span> <span class='id identifier rubyid_new_email_address'>new_email_address</span><span class='comma'>,</span> <span class='label'>community_id:</span> <span class='ivar'>@current_community</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rparen'>)</span>
    <span class='rbrace'>}</span>

    <span class='kw'>if</span> <span class='id identifier rubyid_target_user'>target_user</span><span class='period'>.</span><span class='id identifier rubyid_custom_update'>custom_update</span><span class='lparen'>(</span><span class='id identifier rubyid_person_params'>person_params</span><span class='period'>.</span><span class='id identifier rubyid_except'>except</span><span class='lparen'>(</span><span class='symbol'>:email_attributes</span><span class='rparen'>)</span><span class='rparen'>)</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:person</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:password</span><span class='rbracket'>]</span>
        <span class='comment'>#if password changed Devise needs a new sign in.
</span>        <span class='id identifier rubyid_bypass_sign_in'>bypass_sign_in</span><span class='lparen'>(</span><span class='id identifier rubyid_target_user'>target_user</span><span class='rparen'>)</span>
      <span class='kw'>end</span>

      <span class='id identifier rubyid_m_email_address'>m_email_address</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='lbrace'>{</span>
        <span class='comment'># A new email was added, send confirmation email to the latest address
</span>        <span class='const'><span class='object_link'><a href="Email.html" title="Email (class)">Email</a></span></span><span class='period'>.</span><span class='id identifier rubyid_send_confirmation'><span class='object_link'><a href="Email.html#send_confirmation-class_method" title="Email.send_confirmation (method)">send_confirmation</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_target_user'>target_user</span><span class='period'>.</span><span class='id identifier rubyid_emails'>emails</span><span class='period'>.</span><span class='id identifier rubyid_last'>last</span><span class='comma'>,</span> <span class='ivar'>@current_community</span><span class='rparen'>)</span>
      <span class='rbrace'>}</span>

      <span class='id identifier rubyid_flash'>flash</span><span class='lbracket'>[</span><span class='symbol'>:notice</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_t'>t</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>layouts.notifications.person_updated_successfully</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>

      <span class='comment'># Send new confirmation email, if was changing for that
</span>      <span class='kw'>if</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>request_new_email_confirmation</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span>
          <span class='id identifier rubyid_target_user'>target_user</span><span class='period'>.</span><span class='id identifier rubyid_send_confirmation_instructions'>send_confirmation_instructions</span><span class='lparen'>(</span><span class='id identifier rubyid_request'>request</span><span class='period'>.</span><span class='id identifier rubyid_host_with_port'>host_with_port</span><span class='comma'>,</span> <span class='ivar'>@current_community</span><span class='rparen'>)</span>
          <span class='id identifier rubyid_flash'>flash</span><span class='lbracket'>[</span><span class='symbol'>:notice</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_t'>t</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>layouts.notifications.email_confirmation_sent_to_new_address</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
      <span class='kw'>end</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_flash'>flash</span><span class='lbracket'>[</span><span class='symbol'>:error</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_t'>t</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>layouts.notifications.</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_target_user'>target_user</span><span class='period'>.</span><span class='id identifier rubyid_errors'>errors</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>rescue</span> <span class='const'>RestClient</span><span class='op'>::</span><span class='const'>RequestFailed</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
    <span class='id identifier rubyid_flash'>flash</span><span class='lbracket'>[</span><span class='symbol'>:error</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_t'>t</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>layouts.notifications.update_error</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_redirect_back'>redirect_back</span><span class='lparen'>(</span><span class='label'>fallback_location:</span> <span class='id identifier rubyid_homepage_url'>homepage_url</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

      <div id="footer">
  Generated on Tue Feb 11 14:02:03 2020 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.19 (ruby-2.6.2).
</div>

    </div>
  </body>
</html>