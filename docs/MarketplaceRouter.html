<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  Module: MarketplaceRouter
  
    &mdash; Documentation by YARD 0.9.19
  
</title>

  <link rel="stylesheet" href="css/style.css" type="text/css" charset="utf-8" />

  <link rel="stylesheet" href="css/common.css" type="text/css" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  pathId = "MarketplaceRouter";
  relpath = '';
</script>


  <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="class_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="_index.html">Index (M)</a> &raquo;
    
    
    <span class="title">MarketplaceRouter</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><h1>Module: MarketplaceRouter
  
  
  
</h1>
<div class="box_info">
  

  
  
  
  
  

  

  
  <dl>
    <dt>Defined in:</dt>
    <dd>app/utils/marketplace_router.rb</dd>
  </dl>
  
</div>

<h2>Defined Under Namespace</h2>
<p class="children">
  
    
      <strong class="modules">Modules:</strong> <span class='object_link'><a href="MarketplaceRouter/DataTypes.html" title="MarketplaceRouter::DataTypes (module)">DataTypes</a></span>
    
  
    
  
</p>

  
    <h2>
      Constant Summary
      <small><a href="#" class="constants_summary_toggle">collapse</a></small>
    </h2>

    <dl class="constants">
      
        <dt id="ERROR_MESSAGES-constant" class="">ERROR_MESSAGES =
          
        </dt>
        <dd><pre class="code"><span class='lbrace'>{</span>
  <span class='label'>closed:</span> <span class='lbrace'>{</span>
    <span class='label'>title:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Whoops, the %{community_name} marketplace no longer exists!</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
    <span class='label'>description:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Unfortunately the %{community_name} team has decided to close this platform, and it is no longer available.</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
    <span class='label'>cta:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Create your own online marketplace</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
    <span class='label'>cta_url:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>https://www.sharetribe.com/?utm_source=%{marketplace_ident}.sharetribe.com&amp;utm_medium=redirect&amp;utm_campaign=qc-manual-redirect</span><span class='tstring_end'>&quot;</span></span>
  <span class='rbrace'>}</span><span class='comma'>,</span>

  <span class='label'>deleted:</span> <span class='lbrace'>{</span>
    <span class='label'>title:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Whoops, the %{community_name} marketplace no longer exists!</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
    <span class='label'>description:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Unfortunately the %{community_name} team has decided to close this platform, and it is no longer available.</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
    <span class='label'>cta:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Create your own online marketplace</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
    <span class='label'>cta_url:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>https://www.sharetribe.com/?utm_source=%{marketplace_ident}.sharetribe.com&amp;utm_medium=redirect&amp;utm_campaign=dl-manual-redirect</span><span class='tstring_end'>&quot;</span></span>
  <span class='rbrace'>}</span><span class='comma'>,</span>

  <span class='label'>hold:</span> <span class='lbrace'>{</span>
    <span class='label'>title:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>The %{community_name} marketplace is on hold.</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
    <span class='label'>description:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>The %{community_name} team has decided to pause things and they will reopen this platform in the future</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
    <span class='label'>use_marketplace_logo:</span> <span class='kw'>true</span>
  <span class='rbrace'>}</span>
<span class='rbrace'>}</span></pre></dd>
      
    </dl>
  







  
    <h2>
      Class Method Summary
      <small><a href="#" class="summary_toggle">collapse</a></small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#community_hash-class_method" title="community_hash (class method)">.<strong>community_hash</strong>(community, plan)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Takes a Community model and Plan entity.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#domain_redirect_url-class_method" title="domain_redirect_url (class method)">.<strong>domain_redirect_url</strong>(domain:, request:)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#host_redirect_url-class_method" title="host_redirect_url (class method)">.<strong>host_redirect_url</strong>(host:, request:)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#ident_redirect_url-class_method" title="ident_redirect_url (class method)">.<strong>ident_redirect_url</strong>(ident:, app_domain:, request:)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#make_error_message-class_method" title="make_error_message (class method)">.<strong>make_error_message</strong>(community, reason)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#perform_redirect-class_method" title="perform_redirect (class method)">.<strong>perform_redirect</strong>(community:, plan:, request:, &amp;block)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>This method is not side-effect free: It&#39;s aware of the global application configs.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#redirect_reason-class_method" title="redirect_reason (class method)">.<strong>redirect_reason</strong>(community:, host:, no_communities:, app_domain:)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Returns a redirect reason or nil, if no redirect should be made.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#redirect_target-class_method" title="redirect_target (class method)">.<strong>redirect_target</strong>(reason:, request:, community:, paths:, configs:, message: nil)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Returns a hash, which contains either a url or named route.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#request_hash-class_method" title="request_hash (class method)">.<strong>request_hash</strong>(request)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Takes an ActionDispatch::Request or Rack::Request.</p>
</div></span>
  
</li>

      
    </ul>
  



  <div id="class_method_details" class="method_details_list">
    <h2>Class Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="community_hash-class_method">
  
    .<strong>community_hash</strong>(community, plan)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Takes a Community model and Plan entity.</p>

<p>Returns a Hash in a form that MarketplaceRouter expects</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


279
280
281
282
283
284
285
286
287
288
289
290</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/utils/marketplace_router.rb', line 279</span>

<span class='kw'>def</span> <span class='id identifier rubyid_community_hash'>community_hash</span><span class='lparen'>(</span><span class='id identifier rubyid_community'>community</span><span class='comma'>,</span> <span class='id identifier rubyid_plan'>plan</span><span class='rparen'>)</span>
  <span class='const'>Maybe</span><span class='lparen'>(</span><span class='id identifier rubyid_community'>community</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_c'>c</span><span class='op'>|</span>
    <span class='lbrace'>{</span>
      <span class='label'>ident:</span> <span class='id identifier rubyid_c'>c</span><span class='period'>.</span><span class='id identifier rubyid_ident'>ident</span><span class='comma'>,</span>
      <span class='label'>domain:</span> <span class='id identifier rubyid_c'>c</span><span class='period'>.</span><span class='id identifier rubyid_domain'>domain</span><span class='comma'>,</span>
      <span class='label'>deleted:</span> <span class='id identifier rubyid_c'>c</span><span class='period'>.</span><span class='id identifier rubyid_deleted?'>deleted?</span><span class='comma'>,</span>
      <span class='label'>use_domain:</span> <span class='id identifier rubyid_c'>c</span><span class='period'>.</span><span class='id identifier rubyid_use_domain?'>use_domain?</span><span class='comma'>,</span>
      <span class='label'>closed:</span> <span class='const'>Maybe</span><span class='lparen'>(</span><span class='id identifier rubyid_plan'>plan</span><span class='rparen'>)</span><span class='lbracket'>[</span><span class='symbol'>:closed</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_or_else'>or_else</span><span class='lparen'>(</span><span class='kw'>false</span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>hold:</span> <span class='const'>Maybe</span><span class='lparen'>(</span><span class='id identifier rubyid_plan'>plan</span><span class='rparen'>)</span><span class='lbracket'>[</span><span class='symbol'>:hold</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_or_else'>or_else</span><span class='lparen'>(</span><span class='kw'>false</span><span class='rparen'>)</span>
    <span class='rbrace'>}</span>
  <span class='rbrace'>}</span><span class='period'>.</span><span class='id identifier rubyid_or_else'>or_else</span><span class='lparen'>(</span><span class='kw'>nil</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="domain_redirect_url-class_method">
  
    .<strong>domain_redirect_url</strong>(domain:, request:)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


184
185
186</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/utils/marketplace_router.rb', line 184</span>

<span class='kw'>def</span> <span class='id identifier rubyid_domain_redirect_url'>domain_redirect_url</span><span class='lparen'>(</span><span class='label'>domain:</span><span class='comma'>,</span> <span class='label'>request:</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_host_redirect_url'>host_redirect_url</span><span class='lparen'>(</span><span class='label'>host:</span> <span class='id identifier rubyid_domain'>domain</span><span class='comma'>,</span> <span class='label'>request:</span> <span class='id identifier rubyid_request'>request</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="host_redirect_url-class_method">
  
    .<strong>host_redirect_url</strong>(host:, request:)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


192
193
194</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/utils/marketplace_router.rb', line 192</span>

<span class='kw'>def</span> <span class='id identifier rubyid_host_redirect_url'>host_redirect_url</span><span class='lparen'>(</span><span class='label'>host:</span><span class='comma'>,</span> <span class='label'>request:</span><span class='rparen'>)</span>
  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_request'>request</span><span class='lbracket'>[</span><span class='symbol'>:protocol</span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_host'>host</span><span class='embexpr_end'>}</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_request'>request</span><span class='lbracket'>[</span><span class='symbol'>:port_string</span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_request'>request</span><span class='lbracket'>[</span><span class='symbol'>:fullpath</span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="ident_redirect_url-class_method">
  
    .<strong>ident_redirect_url</strong>(ident:, app_domain:, request:)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


188
189
190</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/utils/marketplace_router.rb', line 188</span>

<span class='kw'>def</span> <span class='id identifier rubyid_ident_redirect_url'>ident_redirect_url</span><span class='lparen'>(</span><span class='label'>ident:</span><span class='comma'>,</span> <span class='label'>app_domain:</span><span class='comma'>,</span> <span class='label'>request:</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_host_redirect_url'>host_redirect_url</span><span class='lparen'>(</span><span class='label'>host:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_ident'>ident</span><span class='embexpr_end'>}</span><span class='tstring_content'>.</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_app_domain'>app_domain</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>request:</span> <span class='id identifier rubyid_request'>request</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="make_error_message-class_method">
  
    .<strong>make_error_message</strong>(community, reason)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/utils/marketplace_router.rb', line 292</span>

<span class='kw'>def</span> <span class='id identifier rubyid_make_error_message'>make_error_message</span><span class='lparen'>(</span><span class='id identifier rubyid_community'>community</span><span class='comma'>,</span> <span class='id identifier rubyid_reason'>reason</span><span class='rparen'>)</span>
  <span class='kw'>return</span> <span class='kw'>nil</span> <span class='kw'>unless</span> <span class='const'><span class='object_link'><a href="#ERROR_MESSAGES-constant" title="MarketplaceRouter::ERROR_MESSAGES (constant)">ERROR_MESSAGES</a></span></span><span class='lbracket'>[</span><span class='id identifier rubyid_reason'>reason</span><span class='rbracket'>]</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_community'>community</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'><span class='object_link'><a href="Community.html" title="Community (class)">Community</a></span></span><span class='rparen'>)</span>

  <span class='id identifier rubyid_ident'>ident</span> <span class='op'>=</span> <span class='id identifier rubyid_community'>community</span><span class='period'>.</span><span class='id identifier rubyid_ident'>ident</span>
  <span class='id identifier rubyid_community_name'>community_name</span> <span class='op'>=</span>
    <span class='kw'>begin</span>
      <span class='id identifier rubyid_community'>community</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span><span class='lparen'>(</span><span class='id identifier rubyid_community'>community</span><span class='period'>.</span><span class='id identifier rubyid_default_locale'>default_locale</span><span class='rparen'>)</span>
    <span class='kw'>rescue</span> <span class='const'>StandardError</span>
      <span class='id identifier rubyid_ident'>ident</span>
    <span class='kw'>end</span>

  <span class='id identifier rubyid_var_map'>var_map</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>community_name</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_community_name'>community_name</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>marketplace_ident</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_ident'>ident</span><span class='rbrace'>}</span>
  <span class='id identifier rubyid_message'>message</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='label'>reason:</span> <span class='id identifier rubyid_reason'>reason</span><span class='rbrace'>}</span>

  <span class='const'><span class='object_link'><a href="#ERROR_MESSAGES-constant" title="MarketplaceRouter::ERROR_MESSAGES (constant)">ERROR_MESSAGES</a></span></span><span class='lbracket'>[</span><span class='id identifier rubyid_reason'>reason</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_key'>key</span><span class='comma'>,</span> <span class='id identifier rubyid_value'>value</span><span class='op'>|</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_key'>key</span> <span class='op'>==</span> <span class='symbol'>:use_marketplace_logo</span>
      <span class='id identifier rubyid_message'>message</span><span class='lbracket'>[</span><span class='id identifier rubyid_key'>key</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_value'>value</span>
      <span class='id identifier rubyid_message'>message</span><span class='lbracket'>[</span><span class='symbol'>:logo</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_community'>community</span><span class='period'>.</span><span class='id identifier rubyid_wide_logo'>wide_logo</span><span class='period'>.</span><span class='id identifier rubyid_present?'>present?</span> <span class='op'>?</span> <span class='id identifier rubyid_community'>community</span><span class='period'>.</span><span class='id identifier rubyid_wide_logo'>wide_logo</span><span class='period'>.</span><span class='id identifier rubyid_url'>url</span><span class='lparen'>(</span><span class='symbol'>:header_highres</span><span class='rparen'>)</span> <span class='op'>:</span> <span class='kw'>nil</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_message'>message</span><span class='lbracket'>[</span><span class='id identifier rubyid_key'>key</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_value'>value</span><span class='period'>.</span><span class='id identifier rubyid_gsub'>gsub</span><span class='lparen'>(</span><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>%\{(\w+)\}</span><span class='regexp_end'>/</span></span><span class='rparen'>)</span><span class='lbrace'>{</span><span class='op'>|</span><span class='id identifier rubyid_var_name'>var_name</span><span class='op'>|</span> <span class='id identifier rubyid_var_map'>var_map</span><span class='lbracket'>[</span><span class='const'>Regexp</span><span class='period'>.</span><span class='id identifier rubyid_last_match'>last_match</span><span class='lbracket'>[</span><span class='int'>1</span><span class='rbracket'>]</span><span class='rbracket'>]</span> <span class='rbrace'>}</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_message'>message</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="perform_redirect-class_method">
  
    .<strong>perform_redirect</strong>(community:, plan:, request:, &amp;block)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>This method is not side-effect free: It&#39;s aware of the global application configs. You can use this method in a controller. This method will call the block if redirect is needed.</p>

<p>The method returns `true` if redirect is needed, so you can use it as a guard:</p>

<p>“` def index</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>return</span> <span class='kw'>if</span> <span class='const'><span class='object_link'><a href="" title="MarketplaceRouter (module)">MarketplaceRouter</a></span></span><span class='period'>.</span><span class='id identifier rubyid_perform_redirect'>perform_redirect</span><span class='lparen'>(</span><span class='label'>community:</span> <span class='ivar'>@current_community</span><span class='comma'>,</span> <span class='label'>plan:</span> <span class='ivar'>@current_plan</span><span class='comma'>,</span> <span class='label'>request:</span> <span class='id identifier rubyid_request'>request</span><span class='rparen'>)</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_target'>target</span><span class='op'>|</span>
  <span class='id identifier rubyid_url'>url</span> <span class='op'>=</span> <span class='id identifier rubyid_target'>target</span><span class='lbracket'>[</span><span class='symbol'>:url</span><span class='rbracket'>]</span> <span class='op'>||</span> <span class='id identifier rubyid_send'>send</span><span class='lparen'>(</span><span class='id identifier rubyid_target'>target</span><span class='lbracket'>[</span><span class='symbol'>:route_name</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='label'>protocol:</span> <span class='id identifier rubyid_target'>target</span><span class='lbracket'>[</span><span class='symbol'>:protocol</span><span class='rbracket'>]</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_redirect_to'>redirect_to</span><span class='lparen'>(</span><span class='id identifier rubyid_url'>url</span><span class='comma'>,</span> <span class='label'>status:</span> <span class='id identifier rubyid_target'>target</span><span class='lbracket'>[</span><span class='symbol'>:status</span><span class='rbracket'>]</span><span class='rparen'>)</span>
<span class='rbrace'>}</span>
</code></pre>

<p>end “`</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/utils/marketplace_router.rb', line 235</span>

<span class='kw'>def</span> <span class='id identifier rubyid_perform_redirect'>perform_redirect</span><span class='lparen'>(</span><span class='label'>community:</span><span class='comma'>,</span> <span class='label'>plan:</span><span class='comma'>,</span> <span class='label'>request:</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_paths'>paths</span> <span class='op'>=</span> <span class='lbrace'>{</span>
    <span class='label'>community_not_found:</span> <span class='const'>Maybe</span><span class='lparen'>(</span><span class='const'>APP_CONFIG</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_community_not_found_redirect'>community_not_found_redirect</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_url'>url</span><span class='op'>|</span> <span class='lbrace'>{</span><span class='label'>url:</span> <span class='id identifier rubyid_url'>url</span><span class='rbrace'>}</span> <span class='rbrace'>}</span><span class='period'>.</span><span class='id identifier rubyid_or_else'>or_else</span><span class='lparen'>(</span><span class='lbrace'>{</span><span class='label'>route_name:</span> <span class='symbol'>:community_not_found_path</span><span class='rbrace'>}</span><span class='rparen'>)</span><span class='comma'>,</span>
    <span class='label'>new_community:</span> <span class='lbrace'>{</span><span class='label'>route_name:</span> <span class='symbol'>:new_community_path</span><span class='rbrace'>}</span>
  <span class='rbrace'>}</span>

  <span class='id identifier rubyid_configs'>configs</span> <span class='op'>=</span> <span class='lbrace'>{</span>
    <span class='label'>app_domain:</span> <span class='const'><span class='object_link'><a href="URLUtils.html" title="URLUtils (module)">URLUtils</a></span></span><span class='period'>.</span><span class='id identifier rubyid_strip_port_from_host'><span class='object_link'><a href="URLUtils.html#strip_port_from_host-class_method" title="URLUtils.strip_port_from_host (method)">strip_port_from_host</a></span></span><span class='lparen'>(</span><span class='const'>APP_CONFIG</span><span class='period'>.</span><span class='id identifier rubyid_domain'>domain</span><span class='rparen'>)</span>
  <span class='rbrace'>}</span>

  <span class='id identifier rubyid_reason'>reason</span> <span class='op'>=</span> <span class='id identifier rubyid_request'>request</span><span class='period'>.</span><span class='id identifier rubyid_env'>env</span><span class='lbracket'>[</span><span class='symbol'>:redirect_reason</span><span class='rbracket'>]</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_reason'>reason</span>
    <span class='id identifier rubyid_target'>target</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="" title="MarketplaceRouter (module)">MarketplaceRouter</a></span></span><span class='period'>.</span><span class='id identifier rubyid_redirect_target'><span class='object_link'><a href="#redirect_target-class_method" title="MarketplaceRouter.redirect_target (method)">redirect_target</a></span></span><span class='lparen'>(</span>
      <span class='label'>reason:</span> <span class='id identifier rubyid_reason'>reason</span><span class='comma'>,</span>
      <span class='label'>request:</span> <span class='const'><span class='object_link'><a href="" title="MarketplaceRouter (module)">MarketplaceRouter</a></span></span><span class='period'>.</span><span class='id identifier rubyid_request_hash'><span class='object_link'><a href="#request_hash-class_method" title="MarketplaceRouter.request_hash (method)">request_hash</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_request'>request</span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>community:</span> <span class='const'><span class='object_link'><a href="" title="MarketplaceRouter (module)">MarketplaceRouter</a></span></span><span class='period'>.</span><span class='id identifier rubyid_community_hash'><span class='object_link'><a href="#community_hash-class_method" title="MarketplaceRouter.community_hash (method)">community_hash</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_community'>community</span><span class='comma'>,</span> <span class='id identifier rubyid_plan'>plan</span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='label'>paths:</span> <span class='id identifier rubyid_paths'>paths</span><span class='comma'>,</span>
      <span class='label'>configs:</span> <span class='id identifier rubyid_configs'>configs</span><span class='comma'>,</span>
      <span class='label'>message:</span> <span class='const'><span class='object_link'><a href="" title="MarketplaceRouter (module)">MarketplaceRouter</a></span></span><span class='period'>.</span><span class='id identifier rubyid_make_error_message'><span class='object_link'><a href="#make_error_message-class_method" title="MarketplaceRouter.make_error_message (method)">make_error_message</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_community'>community</span><span class='comma'>,</span> <span class='id identifier rubyid_reason'>reason</span><span class='rparen'>)</span>
    <span class='rparen'>)</span>

    <span class='id identifier rubyid_block'>block</span><span class='period'>.</span><span class='id identifier rubyid_call'>call</span><span class='lparen'>(</span><span class='id identifier rubyid_target'>target</span><span class='rparen'>)</span>
    <span class='kw'>true</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="redirect_reason-class_method">
  
    .<strong>redirect_reason</strong>(community:, host:, no_communities:, app_domain:)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Returns a redirect reason or nil, if no redirect should be made</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/utils/marketplace_router.rb', line 198</span>

<span class='kw'>def</span> <span class='id identifier rubyid_redirect_reason'>redirect_reason</span><span class='lparen'>(</span><span class='label'>community:</span><span class='comma'>,</span> <span class='label'>host:</span><span class='comma'>,</span> <span class='label'>no_communities:</span><span class='comma'>,</span> <span class='label'>app_domain:</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_community'>community</span> <span class='op'>=</span> <span class='const'>Maybe</span><span class='lparen'>(</span><span class='id identifier rubyid_community'>community</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_c'>c</span><span class='op'>|</span> <span class='const'><span class='object_link'><a href="MarketplaceRouter/DataTypes.html" title="MarketplaceRouter::DataTypes (module)">DataTypes</a></span></span><span class='period'>.</span><span class='id identifier rubyid_create_community'><span class='object_link'><a href="MarketplaceRouter/DataTypes.html#create_community-class_method" title="MarketplaceRouter::DataTypes.create_community (method)">create_community</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_c'>c</span><span class='rparen'>)</span> <span class='rbrace'>}</span><span class='period'>.</span><span class='id identifier rubyid_or_else'>or_else</span><span class='lparen'>(</span><span class='kw'>nil</span><span class='rparen'>)</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_no_communities'>no_communities</span>
    <span class='symbol'>:no_marketplaces</span>
  <span class='kw'>elsif</span> <span class='id identifier rubyid_community'>community</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_no_communities'>no_communities</span>
    <span class='symbol'>:not_found</span>
  <span class='kw'>elsif</span> <span class='id identifier rubyid_community'>community</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_community'>community</span><span class='lbracket'>[</span><span class='symbol'>:deleted</span><span class='rbracket'>]</span>
    <span class='symbol'>:deleted</span>
  <span class='kw'>elsif</span> <span class='id identifier rubyid_community'>community</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_community'>community</span><span class='lbracket'>[</span><span class='symbol'>:hold</span><span class='rbracket'>]</span>
    <span class='symbol'>:hold</span>
  <span class='kw'>elsif</span> <span class='id identifier rubyid_community'>community</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_community'>community</span><span class='lbracket'>[</span><span class='symbol'>:closed</span><span class='rbracket'>]</span>
    <span class='symbol'>:closed</span>
  <span class='kw'>elsif</span> <span class='id identifier rubyid_community'>community</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_community'>community</span><span class='lbracket'>[</span><span class='symbol'>:domain</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_present?'>present?</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_community'>community</span><span class='lbracket'>[</span><span class='symbol'>:use_domain</span><span class='rbracket'>]</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_host'>host</span> <span class='op'>!=</span> <span class='id identifier rubyid_community'>community</span><span class='lbracket'>[</span><span class='symbol'>:domain</span><span class='rbracket'>]</span>
    <span class='symbol'>:use_domain</span>
  <span class='kw'>elsif</span> <span class='id identifier rubyid_community'>community</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_community'>community</span><span class='lbracket'>[</span><span class='symbol'>:domain</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_present?'>present?</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_community'>community</span><span class='lbracket'>[</span><span class='symbol'>:use_domain</span><span class='rbracket'>]</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_host'>host</span> <span class='op'>==</span> <span class='id identifier rubyid_community'>community</span><span class='lbracket'>[</span><span class='symbol'>:domain</span><span class='rbracket'>]</span>
    <span class='symbol'>:use_ident</span>
  <span class='kw'>elsif</span> <span class='id identifier rubyid_community'>community</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_host'>host</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>www.</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_community'>community</span><span class='lbracket'>[</span><span class='symbol'>:ident</span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_content'>.</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_app_domain'>app_domain</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='symbol'>:www_ident</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="redirect_target-class_method">
  
    .<strong>redirect_target</strong>(reason:, request:, community:, paths:, configs:, message: nil)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Returns a hash, which contains either a url or named route</p>

<p>Example, return hash with url:</p>

<p>{ url: “<a href="https://marketplace.sharetribe.com/listings">marketplace.sharetribe.com/listings</a>”, status :found }</p>

<p>Example, return hash with named route:</p>

<p>{ route_name: :new_community, status: :moved_permanently, protocol: “http”}</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/utils/marketplace_router.rb', line 120</span>

<span class='kw'>def</span> <span class='id identifier rubyid_redirect_target'>redirect_target</span><span class='lparen'>(</span><span class='label'>reason:</span><span class='comma'>,</span> <span class='label'>request:</span><span class='comma'>,</span> <span class='label'>community:</span><span class='comma'>,</span> <span class='label'>paths:</span><span class='comma'>,</span> <span class='label'>configs:</span><span class='comma'>,</span> <span class='label'>message:</span> <span class='kw'>nil</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_community'>community</span> <span class='op'>=</span> <span class='const'>Maybe</span><span class='lparen'>(</span><span class='id identifier rubyid_community'>community</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_c'>c</span><span class='op'>|</span> <span class='const'><span class='object_link'><a href="MarketplaceRouter/DataTypes.html" title="MarketplaceRouter::DataTypes (module)">DataTypes</a></span></span><span class='period'>.</span><span class='id identifier rubyid_create_community'><span class='object_link'><a href="MarketplaceRouter/DataTypes.html#create_community-class_method" title="MarketplaceRouter::DataTypes.create_community (method)">create_community</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_c'>c</span><span class='rparen'>)</span> <span class='rbrace'>}</span><span class='period'>.</span><span class='id identifier rubyid_or_else'>or_else</span><span class='lparen'>(</span><span class='kw'>nil</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_request'>request</span>   <span class='op'>=</span> <span class='const'><span class='object_link'><a href="MarketplaceRouter/DataTypes.html" title="MarketplaceRouter::DataTypes (module)">DataTypes</a></span></span><span class='period'>.</span><span class='id identifier rubyid_create_request'><span class='object_link'><a href="MarketplaceRouter/DataTypes.html#create_request-class_method" title="MarketplaceRouter::DataTypes.create_request (method)">create_request</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_request'>request</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_paths'>paths</span>     <span class='op'>=</span> <span class='const'><span class='object_link'><a href="MarketplaceRouter/DataTypes.html" title="MarketplaceRouter::DataTypes (module)">DataTypes</a></span></span><span class='period'>.</span><span class='id identifier rubyid_create_paths'><span class='object_link'><a href="MarketplaceRouter/DataTypes.html#create_paths-class_method" title="MarketplaceRouter::DataTypes.create_paths (method)">create_paths</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_paths'>paths</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_configs'>configs</span>   <span class='op'>=</span> <span class='const'><span class='object_link'><a href="MarketplaceRouter/DataTypes.html" title="MarketplaceRouter::DataTypes (module)">DataTypes</a></span></span><span class='period'>.</span><span class='id identifier rubyid_create_configs'><span class='object_link'><a href="MarketplaceRouter/DataTypes.html#create_configs-class_method" title="MarketplaceRouter::DataTypes.create_configs (method)">create_configs</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_configs'>configs</span><span class='rparen'>)</span>

  <span class='id identifier rubyid_target'>target</span> <span class='op'>=</span>
    <span class='kw'>case</span> <span class='id identifier rubyid_reason'>reason</span>
    <span class='kw'>when</span> <span class='symbol'>:no_marketplaces</span>
      <span class='comment'># Community not found, because there are no communities
</span>      <span class='comment'># -&gt; Redirect to new community page
</span>      <span class='id identifier rubyid_paths'>paths</span><span class='lbracket'>[</span><span class='symbol'>:new_community</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_merge'>merge</span><span class='lparen'>(</span><span class='label'>status:</span> <span class='symbol'>:found</span><span class='comma'>,</span> <span class='label'>protocol:</span> <span class='id identifier rubyid_request'>request</span><span class='lbracket'>[</span><span class='symbol'>:protocol</span><span class='rbracket'>]</span><span class='rparen'>)</span>
    <span class='kw'>when</span> <span class='symbol'>:not_found</span>
      <span class='comment'># Community not found
</span>      <span class='comment'># -&gt; Redirect to not found
</span>      <span class='const'>Maybe</span><span class='lparen'>(</span><span class='id identifier rubyid_paths'>paths</span><span class='lbracket'>[</span><span class='symbol'>:community_not_found</span><span class='rbracket'>]</span><span class='rparen'>)</span><span class='lbracket'>[</span><span class='symbol'>:url</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_u'>u</span><span class='op'>|</span>
        <span class='const'><span class='object_link'><a href="URLUtils.html" title="URLUtils (module)">URLUtils</a></span></span><span class='period'>.</span><span class='id identifier rubyid_build_url'><span class='object_link'><a href="URLUtils.html#build_url-class_method" title="URLUtils.build_url (method)">build_url</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_u'>u</span><span class='comma'>,</span> <span class='lbrace'>{</span><span class='label'>utm_source:</span> <span class='id identifier rubyid_request'>request</span><span class='lbracket'>[</span><span class='symbol'>:host</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='label'>utm_medium:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>redirect</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>utm_campaign:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>na-auto-redirect</span><span class='tstring_end'>&quot;</span></span><span class='rbrace'>}</span><span class='rparen'>)</span>
      <span class='rbrace'>}</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_u'>u</span><span class='op'>|</span>
        <span class='lbrace'>{</span><span class='label'>url:</span> <span class='id identifier rubyid_u'>u</span><span class='comma'>,</span> <span class='label'>status:</span> <span class='symbol'>:found</span><span class='rbrace'>}</span>
      <span class='rbrace'>}</span><span class='period'>.</span><span class='id identifier rubyid_or_else'>or_else</span> <span class='lbrace'>{</span>
        <span class='id identifier rubyid_paths'>paths</span><span class='lbracket'>[</span><span class='symbol'>:community_not_found</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_merge'>merge</span><span class='lparen'>(</span><span class='label'>status:</span> <span class='symbol'>:found</span><span class='rparen'>)</span>
      <span class='rbrace'>}</span>
    <span class='kw'>when</span> <span class='symbol'>:deleted</span>
      <span class='comment'># Community deleted
</span>      <span class='comment'># -&gt; Redirect to not found
</span>      <span class='const'>Maybe</span><span class='lparen'>(</span><span class='id identifier rubyid_paths'>paths</span><span class='lbracket'>[</span><span class='symbol'>:community_not_found</span><span class='rbracket'>]</span><span class='rparen'>)</span><span class='lbracket'>[</span><span class='symbol'>:url</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_u'>u</span><span class='op'>|</span>
        <span class='const'><span class='object_link'><a href="URLUtils.html" title="URLUtils (module)">URLUtils</a></span></span><span class='period'>.</span><span class='id identifier rubyid_build_url'><span class='object_link'><a href="URLUtils.html#build_url-class_method" title="URLUtils.build_url (method)">build_url</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_u'>u</span><span class='comma'>,</span> <span class='lbrace'>{</span><span class='label'>utm_source:</span> <span class='id identifier rubyid_request'>request</span><span class='lbracket'>[</span><span class='symbol'>:host</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='label'>utm_medium:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>redirect</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>utm_campaign:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>dl-auto-redirect</span><span class='tstring_end'>&quot;</span></span><span class='rbrace'>}</span><span class='rparen'>)</span>
      <span class='rbrace'>}</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_u'>u</span><span class='op'>|</span>
        <span class='lbrace'>{</span><span class='label'>url:</span> <span class='id identifier rubyid_u'>u</span><span class='comma'>,</span> <span class='label'>status:</span> <span class='symbol'>:moved_permanently</span><span class='rbrace'>}</span>
      <span class='rbrace'>}</span><span class='period'>.</span><span class='id identifier rubyid_or_else'>or_else</span> <span class='lbrace'>{</span>
        <span class='id identifier rubyid_paths'>paths</span><span class='lbracket'>[</span><span class='symbol'>:community_not_found</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_merge'>merge</span><span class='lparen'>(</span><span class='label'>status:</span> <span class='symbol'>:moved_permanently</span><span class='rparen'>)</span>
      <span class='rbrace'>}</span>
    <span class='kw'>when</span> <span class='symbol'>:closed</span><span class='comma'>,</span> <span class='symbol'>:hold</span>
      <span class='comment'># Community closed
</span>      <span class='comment'># -&gt; Redirect to not found
</span>      <span class='const'>Maybe</span><span class='lparen'>(</span><span class='id identifier rubyid_paths'>paths</span><span class='lbracket'>[</span><span class='symbol'>:community_not_found</span><span class='rbracket'>]</span><span class='rparen'>)</span><span class='lbracket'>[</span><span class='symbol'>:url</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_u'>u</span><span class='op'>|</span>
        <span class='const'><span class='object_link'><a href="URLUtils.html" title="URLUtils (module)">URLUtils</a></span></span><span class='period'>.</span><span class='id identifier rubyid_build_url'><span class='object_link'><a href="URLUtils.html#build_url-class_method" title="URLUtils.build_url (method)">build_url</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_u'>u</span><span class='comma'>,</span> <span class='lbrace'>{</span><span class='label'>utm_source:</span> <span class='id identifier rubyid_request'>request</span><span class='lbracket'>[</span><span class='symbol'>:host</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='label'>utm_medium:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>redirect</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>utm_campaign:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>qc-auto-redirect</span><span class='tstring_end'>&quot;</span></span><span class='rbrace'>}</span><span class='rparen'>)</span>
      <span class='rbrace'>}</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_u'>u</span><span class='op'>|</span>
        <span class='lbrace'>{</span><span class='label'>url:</span> <span class='id identifier rubyid_u'>u</span><span class='comma'>,</span> <span class='label'>status:</span> <span class='symbol'>:moved_permanently</span><span class='rbrace'>}</span>
      <span class='rbrace'>}</span><span class='period'>.</span><span class='id identifier rubyid_or_else'>or_else</span> <span class='lbrace'>{</span>
        <span class='id identifier rubyid_paths'>paths</span><span class='lbracket'>[</span><span class='symbol'>:community_not_found</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_merge'>merge</span><span class='lparen'>(</span><span class='label'>status:</span> <span class='symbol'>:moved_permanently</span><span class='rparen'>)</span>
      <span class='rbrace'>}</span>
    <span class='kw'>when</span> <span class='symbol'>:use_domain</span>
      <span class='comment'># Community has domain ready, should use it
</span>      <span class='comment'># -&gt; Redirect to community domain
</span>      <span class='lbrace'>{</span> <span class='label'>url:</span> <span class='id identifier rubyid_domain_redirect_url'>domain_redirect_url</span><span class='lparen'>(</span><span class='label'>domain:</span> <span class='id identifier rubyid_community'>community</span><span class='lbracket'>[</span><span class='symbol'>:domain</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='label'>request:</span> <span class='id identifier rubyid_request'>request</span><span class='rparen'>)</span><span class='comma'>,</span>
        <span class='label'>status:</span> <span class='symbol'>:moved_permanently</span>
      <span class='rbrace'>}</span>
    <span class='kw'>when</span> <span class='symbol'>:use_ident</span><span class='comma'>,</span> <span class='symbol'>:www_ident</span>
      <span class='comment'># Community has a domain, but it&#39;s not in use.
</span>      <span class='comment'># -&gt; Redirect to subdomain (ident)
</span>      <span class='comment'># OR
</span>      <span class='comment'># Accessed community with ident, including www
</span>      <span class='comment'># -&gt; Redirect to ident without www
</span>      <span class='lbrace'>{</span> <span class='label'>url:</span> <span class='id identifier rubyid_ident_redirect_url'>ident_redirect_url</span><span class='lparen'>(</span><span class='label'>ident:</span> <span class='id identifier rubyid_community'>community</span><span class='lbracket'>[</span><span class='symbol'>:ident</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='label'>app_domain:</span> <span class='id identifier rubyid_configs'>configs</span><span class='lbracket'>[</span><span class='symbol'>:app_domain</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='label'>request:</span> <span class='id identifier rubyid_request'>request</span><span class='rparen'>)</span><span class='comma'>,</span>
        <span class='label'>status:</span> <span class='symbol'>:moved_permanently</span>
      <span class='rbrace'>}</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='const'>ArgumentError</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Unknown redirect reason: &#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_reason'>reason</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39;</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='kw'>end</span>

  <span class='const'><span class='object_link'><a href="HashUtils.html" title="HashUtils (module)">HashUtils</a></span></span><span class='period'>.</span><span class='id identifier rubyid_compact'><span class='object_link'><a href="HashUtils.html#compact-class_method" title="HashUtils.compact (method)">compact</a></span></span><span class='lparen'>(</span><span class='const'><span class='object_link'><a href="MarketplaceRouter/DataTypes.html" title="MarketplaceRouter::DataTypes (module)">DataTypes</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="MarketplaceRouter/DataTypes.html#Target-constant" title="MarketplaceRouter::DataTypes::Target (constant)">Target</a></span></span><span class='period'>.</span><span class='id identifier rubyid_call'>call</span><span class='lparen'>(</span><span class='id identifier rubyid_target'>target</span><span class='period'>.</span><span class='id identifier rubyid_merge'>merge</span><span class='lparen'>(</span><span class='label'>reason:</span> <span class='id identifier rubyid_reason'>reason</span><span class='comma'>,</span> <span class='label'>message:</span> <span class='id identifier rubyid_message'>message</span><span class='rparen'>)</span><span class='rparen'>)</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="request_hash-class_method">
  
    .<strong>request_hash</strong>(request)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Takes an ActionDispatch::Request or Rack::Request</p>

<p>Returns a Hash in a form that MarketplaceRouter expects</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


266
267
268
269
270
271
272
273</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/utils/marketplace_router.rb', line 266</span>

<span class='kw'>def</span> <span class='id identifier rubyid_request_hash'>request_hash</span><span class='lparen'>(</span><span class='id identifier rubyid_request'>request</span><span class='rparen'>)</span>
  <span class='lbrace'>{</span>
    <span class='label'>host:</span> <span class='id identifier rubyid_request'>request</span><span class='period'>.</span><span class='id identifier rubyid_host'>host</span><span class='comma'>,</span>
    <span class='label'>protocol:</span> <span class='lparen'>(</span><span class='id identifier rubyid_request'>request</span><span class='period'>.</span><span class='id identifier rubyid_respond_to?'>respond_to?</span><span class='lparen'>(</span><span class='symbol'>:protocol</span><span class='rparen'>)</span> <span class='op'>?</span> <span class='id identifier rubyid_request'>request</span><span class='period'>.</span><span class='id identifier rubyid_protocol'>protocol</span> <span class='op'>:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_request'>request</span><span class='period'>.</span><span class='id identifier rubyid_scheme'>scheme</span><span class='embexpr_end'>}</span><span class='tstring_content'>://</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='comma'>,</span>
    <span class='label'>fullpath:</span> <span class='id identifier rubyid_request'>request</span><span class='period'>.</span><span class='id identifier rubyid_fullpath'>fullpath</span><span class='comma'>,</span>
    <span class='label'>port_string:</span> <span class='lparen'>(</span><span class='id identifier rubyid_request'>request</span><span class='period'>.</span><span class='id identifier rubyid_respond_to?'>respond_to?</span><span class='lparen'>(</span><span class='symbol'>:port_string</span><span class='rparen'>)</span> <span class='op'>?</span> <span class='id identifier rubyid_request'>request</span><span class='period'>.</span><span class='id identifier rubyid_port_string'>port_string</span> <span class='op'>:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>:</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_request'>request</span><span class='period'>.</span><span class='id identifier rubyid_port'>port</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='rbrace'>}</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

      <div id="footer">
  Generated on Tue Feb 11 14:01:36 2020 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.19 (ruby-2.6.2).
</div>

    </div>
  </body>
</html>